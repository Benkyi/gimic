#
# Written by Jonas Juselius <jonas@iki.fi>
#
#DEBUG=1
#RANGE=1
#PROF=1

topdir:=@top_srcdir@
srcdir:=@srcdir@

include $(topdir)/make.config

vpath %.py tools
vpath %.sh tools

INST_PROGS:=gimic.x gimic tools/MOL2mol.sh tools/turbo2gimic.py tools/qgimic
INST_LIBS:=getkw.py pyparsing.py Atom.py Const.py Elements.py QCTools.py \
	quesys.sh
INST_INCLUDES:=
INST_DATA:=gimic.run 
# module names are listed in smallcaps and wihtout any .mod extension
INST_MODULES:=

ifneq ($(CFOURLIBS),)
INST_PROGS+=xcpdens 
endif

include $(topdir)/make.rules

gimic_objs=kinds.o getkw.o globals.o teletype.o intgrl.o  \
	lip.o gtodefs.o cao2sao.o basis.o reorder.o caos.o dbop.o gaussint.o \
    bfeval.o parallel.o grid.o tensor.o dens.o dfdb.o dfdr.o d2fdrdb.o  \
    jtensor.o timer.o jfield.o divj.o integral.o edens.o factorial.o \
	gimic.o magnet.o

gimic_src=$(wildcard *.f90 *.c)
gimic_libs:=$(LIBS) 

all: $(INST_PROGS) 

gimic: gimic.in
	sed 's/@inst_bindir@/$(subst /,\/,$(inst_bindir))/; s/@inst_libdir@/$(subst /,\/,$(inst_libdir))/; s/@python_bin@/$(PYTHON_BIN)/' $< > $@
	chmod 755 $@

gimic.x: $(gimic_objs) 
	$(FC) $(FLDFLAGS) -o $@ $+ $(gimic_libs) 

xcpdens: xcpdens.o
	$(FC) $(FLDFLAGS) -o $@ $+ $(CFOURLIBS) $(BLAS_LIBS)

tools/MOL2mol.sh: tools/MOL2mol.sh.in
	sed 's/@inst_bindir@/$(subst /,\/,$(inst_bindir))/' $< > $@
	chmod 755 $@

tools/turbo2gimic.py: tools/turbo2gimic.py.in
	sed 's/@inst_bindir@/$(subst /,\/,$(inst_bindir))/; s/@inst_libdir@/$(subst /,\/,$(inst_libdir))/; s/@python_bin@/$(PYTHON_BIN)/' $< > $@
	chmod 755 $@

tools/qgimic: tools/qgimic.sh
	cp -f $< $@
	chmod 755 $@

$(datadir)/gimic.run: tools/gimic.run
	cp -f $< $@

$(libdir)/%.py: %.py
	cp -f $< $@

$(libdir)/%.sh: %.sh
	cp -f $< $@

.PHONY: dep deps
dep deps:
	$(topdir)/config/mkdep90.py $(gimic_src) >deps.mk

ifeq (, $(wildcard $(topdir)/deps.mk))
$(shell $(topdir)/config/mkdep90.py $(gimic_src) >deps.mk)
endif
include $(topdir)/deps.mk
